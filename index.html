<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Data Aggregator and JSON Exporter</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f3ffec; }
        .container { max-width: 4xl; margin-left: auto; margin-right: auto; padding: 2rem; }
        #status-box { background-color: #ffffff; }
        #process-button { background-color: #10b981; } /* Emerald Green */
        #process-button:hover { background-color: #059669; }
        #migration-log { background-color: #f0fdf4; border: 1px solid #d1fae5; }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="text-3xl font-bold text-gray-800 mb-6 text-center">CSV Data Aggregator & JSON Exporter</h1>
        
        <div id="status-box" class="p-6 rounded-xl shadow-2xl transition duration-300">
            <p id="status" class="text-xl font-medium text-gray-700">Tool initialized. Ready to process 9 datasets.</p>
            <p class="text-sm text-gray-500 mt-2">This tool will combine your CSV data, convert dates and numbers, and save the result as a single structured JSON file locally.</p>
        </div>
        
        <button id="process-button" class="mt-6 w-full py-4 text-white font-extrabold rounded-xl shadow-lg hover:shadow-xl transition duration-200 disabled:bg-gray-400">
            Process Data and Download JSON File
        </button>

        <div id="migration-log" class="mt-8 p-4 rounded-xl text-sm h-64 overflow-y-scroll space-y-1">
            <h2 class="font-bold text-gray-800 sticky top-0 bg-[#f0fdf4] pb-2 border-b border-gray-200">Processing Log:</h2>
        </div>
    </div>

    <script>
        // --- Core Utility Functions ---

        /**
         * Parses a date string into a valid Date object.
         */
        function parseDateString(dateStr) {
            const trimmedStr = String(dateStr || '').trim();
            if (trimmedStr === '') { return null; }

            // 1. Try ISO-like format
            let date = new Date(trimmedStr);
            if (!isNaN(date.getTime())) { return date.toISOString(); }

            // 2. Try DD-MM-YYYY format
            const ddMmYyyyMatch = trimmedStr.match(/^(\d{2})[-/](\d{2})[-/](\d{4})(?:\s(\d{2}):(\d{2}):(\d{2}))?$/);
            if (ddMmYyyyMatch) {
                const day = parseInt(ddMmYyyyMatch[1], 10);
                const month = parseInt(ddMmYyyyMatch[2], 10) - 1; 
                const year = parseInt(ddMmYyyyMatch[3], 10);
                const hours = parseInt(ddMmYyyyMatch[4] || '0', 10);
                const minutes = parseInt(ddMmYyyyMatch[5] || '0', 10);
                const seconds = parseInt(ddMmYyyyMatch[6] || '0', 10);
                
                // Use UTC date to avoid local timezone issues
                date = new Date(Date.UTC(year, month, day, hours, minutes, seconds));
                if (!isNaN(date.getTime())) { return date.toISOString(); }
            }

            console.warn(`Could not parse date: "${trimmedStr}". Returning original string.`);
            return trimmedStr; // Return original if parsing fails
        }

        function log(message, isError = false) {
            const entry = document.createElement('p');
            entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            entry.className = isError ? 'text-red-600 font-semibold' : 'text-gray-600';
            logEl.appendChild(entry);
            logEl.scrollTop = logEl.scrollHeight;
            if (isError) {
                console.error(message);
            } else {
                console.log(message);
            }
        }

        function csvToArray(csvString) {
            const lines = csvString.trim().split('\n').filter(line => line.trim() !== '');
            if (lines.length < 1) return [];

            // Simple header extraction and cleaning
            const headers = lines[0].split(',').map(h => h.trim().replace(/^"|"$/g, ''));
            const data = [];

            for (let i = 1; i < lines.length; i++) {
                // Simple split by comma. This is fragile for fields containing commas in quotes, 
                // but handles the data structure provided in the CSV strings.
                const values = lines[i].split(',').map(v => v.trim().replace(/^"|"$/g, ''));
                
                if (values.length !== headers.length) {
                    log(`Skipping potentially malformed line ${i + 1}: Expected ${headers.length} columns, got ${values.length}.`, true);
                    continue; 
                }

                const item = {};
                for (let j = 0; j < headers.length; j++) {
                    item[headers[j]] = values[j];
                }
                data.push(item);
            }
            return data;
        }

        // --- All CSV Data (Cleaned and Verified) ---
        // I will keep these inside the HTML file as requested, ensuring the tool is self-contained.

        const usersCsv = `Username,PasswordHash,Role,Active,Created,Last Login
admin,f88d7ddc8832d21d827b2c52eb1403b79376769855ac27c4ffede67d9d0c0012,admin,True,2025-11-02 14:51:17,2025-11-04
user1,hash1,member,True,2025-10-15 10:00:00,`;

        const transactionsCsv = `Date,Type,Category,Sub-category,Amount,Party,Notes,Cost Center,Payment Mode,Ref/Invoice,Attachment URL,Cleared?
27-09-2025,Income,Maintenance,Common Maintenance,350000,–,Sep 2025 maintenance,Society,Bank,–,–,True
27-09-2025,Income,Events,School Hall Rent,20000,ABC School,–,Community Hall,UPI,–,–,True
27-09-2025,Income,Fines,Parking Fine,1500,"Flat -1201, Tower-1",–,–,Cash,–,–,True
27-09-2025,Expense,Salaries,Security,180000,Falcon Guarding,Sept salary,Security,Bank,INV-123,–,True
27-09-2025,Expense,Salaries,Housekeeping,120000,HK Vendor,Sept,Housekeeping,Bank,INV-456,–,True
27-09-2025,Expense,Utilities,Electricity (Common),95000,State Utility,–,–,Bank,–,–,True
27-09-2025,Expense,Repair & Maintenance,Lift AMC,60000,ABC Elevators,AMC Q3,R&M,Bank,–,–,True`;

        const issuesCsv = `Tracking ID,Date and Time Raised,Tower,Flat,Issue,Description,Media URL,Status,Redressal Remark,User ID,Date and Time Resolved,Time Taken,Feedback Rating
9645,2025-09-17 22:50:00,Tower 1,Flat 405,SmartMeterApp,Thanks,https://api.telegram.org/file/bot8238840551:AAGxhebnFIg8alAIs6eP0L-lJqAQytRxHRo/photos/file_19.jpg,Open,Making it resolved jj,1460260782,2025-09-17 22:51:00,1m,5
8601,2025-09-18 00:00:00,Tower 1,Flat 1906,Washroom,Bharat,https://api.telegram.org/file/bot8238840551:AAGxhebnFIg8alAIs6eP0L-lJqAQytRxHRo/photos/file_19.jpg,InProgress,Assigned to Ramesh (18-Sep 00:01) | Status → Open (18-Sep 00:02),1460260782,,,\n4819,2025-09-19 15:30:00,Tower 1,Flat 1203,Washroom,Happy,https://api.telegram.org/file/bot8238840551:AAGxhebnFIg8alAIs6eP0L-lJqAQytRxHRo/photos/file_20.jpg,Resolved,Testing one more entry and checking typing as well 66666666,1460260782,`;
        
        const chartOfAccountsCsv = `Statement,Group,Category
PL,Income,Maintenance
PL,Income,Events
PL,Income,Fines
PL,Expense,Salaries
PL,Expense,Utilities
PL,Expense,Repair & Maintenance
BS,Asset,Cash
BS,Asset,Bank
BS,Asset,Accounts Receivable
BS,Liability,Advance Maintenance
BS,Liability,Accounts Payable
BS,Equity,Opening Fund`;

        const openingBalancesCsv = `Account,Balance
Cash,25000
Bank,850000
Accounts Receivable,120000
Accounts Payable,45000
Advance Maintenance,200000
Opening Fund,950000`;

        const documentsCsv = `Serial Number,Subject,Date,Media,Link,Category
1,STP,2025-09-25,,https://drive.google.com/file/d/1opE1H0_mWwguRjSaDlGPPVV3wN8Pn2jM/view?usp=drive_link,
2,Jun-25 mobile.pdf,2025-09-25,https://drive.google.com/file/d/1YDFfqUPudIEUNUlVwsTg_hQZOrQS4sKf/view?usp=drivesdk,,n
3,fgzga,2025-09-25,https://drive.google.com/file/d/1YDFfqUPudIEUNUlVwsTg_hQZOrQS4sKf/view?usp=drivesdk,,dddd
5,helpdesk (7).csv,2025-09-25,https://drive.google.com/file/d/1okIikXTJCxan67TLui14rAPpJWiek1J_/view?usp=drivesdk,,
6,1725210544316.jpg,2025-09-25,https://drive.google.com/file/d/1GtdpO4aw2SYjtLwpjufyRGBag29yBbBY/view?usp=drivesdk,,
7,Srujjjjjj System Admin.docx,2025-09-24,https://docs.google.com/document/d/10o4JDjJOpgK8MnBCdsF3sz`; // <-- FIX: Missing closing backtick added here.

        const noticesCsv = `Serial Number,Subject,Date,Notice
1,Water,2025-09-25,STP water in all ways
2,STP,2025-09-25,STP WATER
3,Code,2025-09-25,"<!DOCTYPE html>\n<html lang=""en"">\n<head>\n  <link rel=""alternate icon"" href=""/favicon.ico"">\n  <link rel=""icon"" type=""image/png"" sizes=""32x32"" href=""/favicon-32x32.png"">\n  <link rel=""icon"" type=""image/png"" sizes=""16x16"" href=""/favicon-16x16.png"">\n  <link rel=""apple-touch-icon"" href=""/apple-touch-icon.png"">\n  <link rel=""manifest"" href=""/site.webmanifest"">\n  <meta charset=""UTF-8"">\n  <meta name=""viewport"" content=""width=device-width,initial-scale=1"">\n  <title>Document Repository | Global Hillview</title>\n\n  <!-- No-paint guard -->\n  <script>\n    (function(){ try{ if(!localStorage.getItem('token')){ document.documentElement.style.display='none'; location.replace('/login'); } }catch{ document.documentElement.style.display='none'; location.replace('/login'); }})();\n  </script>\n\n  <style>\n    :root{ --bg:#f7f9fc; --card:#fff; --text:#0f172a; --muted:#6b7280; --border:#e5e7..."}
4,Testing,2025-09-25,Stil testing
5,Test notice,2025-09-25,masx
7,sd,2025-09-25,SGASA
8,JHKHK,2025-09-25,J;JK'LJJ
9,Faltu file,2025-09-25,"Attachment: https://drive.google.com/file/d/1__YMjt0EzSfohKqKV1eqCnPUmVpBc6jv/view?usp=drivesdk\n\nwaise hi"
10,Fan,2025-09-25,"New fans installed in mosque\n\nAttachment: https://drive.google.com/file/d/1I7m4/view?usp=drivesdk"}`;

        const votersCsv = `Tower No.,Flat No.,First Owner Name,Second Owner Name,Membership Card & Share Certificate No,Elegible Voter,Discrepency,Voted Earlier
T1,1204,Mrs. SUNITA CHAWLA,,1,Yes,,Yes
T5,505,Ms. DEEPTI SINHA,,2,Yes,,Yes
T5,302,Ashok Kumar Bansal,,3,Yes,,Yes
T5,304,Mrs. TRIPTI SINHA,,4,Yes,,Yes
T5,507,Nitish Bhardwaj,,5,Yes,,Yes
T1,1505,Mrs. AMITA SINHA,,6,Yes,,Yes
T5,104,Mr. GIRDHAR GOPAL,,7,Yes,,Yes
T1,1601,Mr. PRAVIN RAMAN,KIRAN RAMAN,8,Yes,,Yes
T4,1402,Dr. HILAL AHMAD RATHER,,9,Yes,,Yes
B3,601,Mrs. Samina Qousar,SHEKH MOHAMMAD TARIQ,10,Yes,,Yes
T1,1704,Mr. Mukesh Kumar,,11,Yes,,Yes`;

        const directoryCsv = `Serial,Name,Department,Designation,Shift,Mobile #,Email,Gender,Joind On,Salary
,Maria Lopez,,,,136658,sfgsdf@gmail.con,Female,2025-07-29,
,John Smith,,,,98500,john.smith@example.com,Male,2025-06-14,
,Priya Das,,,,112450,priya.das@example.com,Female,2025-05-02,
,Alan Wong,,,,125000,alan.wong@example.com,Male,2025-04-18,
,Alice Brown,,,,55000,alice.brown@example.com,Female,2025-07-29,
,John Smith,,,,72000,john.smith@example.com,Male,2025-06-15,
,Priya Das,,,,68000,priya.das@example.com,Female,2025-05-10,
,Marco Rossi,,,,61000,marco.rossi@example.com,Male,2025-04-28,
,Sarah Lee,,,,80000,sarah.lee@example.com,Female,2025-03-17,
,David Khan,,,,75000,david.khan@example.com,Male,2025-02-05,
11,Abhishek Srivastava,Finance,VP,Day,9958277484,akram12@srivastava.com`;
        
        // --- End of CSV Data ---


        // --- UI Setup ---
        const statusEl = document.getElementById('status');
        const processButton = document.getElementById('process-button');
        const logEl = document.getElementById('migration-log');


        /**
         * Processes all CSVs, cleans the data types, and aggregates them into a single JSON object.
         * @returns {Object} The complete aggregated data object.
         */
        function aggregateData() {
            log('Starting data aggregation and cleaning...');
            const aggregatedData = {};

            // Helper to clean and structure data for each collection
            function processCollection(csvString, collectionName, preProcess = (item) => item) {
                log(`Processing '${collectionName}'...`);
                const rawData = csvToArray(csvString);
                const processedData = rawData.map(preProcess);
                log(`Finished processing ${processedData.length} records for '${collectionName}'.`);
                return processedData;
            }

            // 1. Users Data
            aggregatedData.users = processCollection(usersCsv, 'users', (item) => {
                item.Active = item.Active === 'True';
                item.Created = parseDateString(item.Created);
                item['Last Login'] = parseDateString(item['Last Login']);
                return item;
            });

            // 2. Transactions Data
            aggregatedData.transactions = processCollection(transactionsCsv, 'transactions', (item) => {
                item.Date = parseDateString(item.Date);
                item.Amount = parseFloat(item.Amount) || 0;
                item['Cleared?'] = item['Cleared?'] === 'True';
                return item;
            });

            // 3. Issues Data
            aggregatedData.issues = processCollection(issuesCsv, 'issues', (item) => {
                item['Date and Time Raised'] = parseDateString(item['Date and Time Raised']);
                item['Date and Time Resolved'] = parseDateString(item['Date and Time Resolved']);
                item['Feedback Rating'] = parseInt(item['Feedback Rating']) || null;
                return item;
            });

            // 4. Chart of Accounts Data (No special conversion needed)
            aggregatedData.chartOfAccounts = processCollection(chartOfAccountsCsv, 'chartOfAccounts');

            // 5. Opening Balances Data
            aggregatedData.openingBalances = processCollection(openingBalancesCsv, 'openingBalances', (item) => {
                item.Balance = parseFloat(item.Balance) || 0;
                return item;
            });

            // 6. Documents Data
            aggregatedData.documents = processCollection(documentsCsv, 'documents', (item) => {
                item.Date = parseDateString(item.Date);
                return item;
            });

            // 7. Notices Data
            aggregatedData.notices = processCollection(noticesCsv, 'notices', (item) => {
                item.Date = parseDateString(item.Date);
                return item;
            });

            // 8. Voters Data
            aggregatedData.voters = processCollection(votersCsv, 'voters', (item) => {
                item['Membership Card & Share Certificate No'] = parseInt(item['Membership Card & Share Certificate No']) || null;
                item['Elegible Voter'] = item['Elegible Voter'] === 'Yes';
                item['Voted Earlier'] = item['Voted Earlier'] === 'Yes';
                return item;
            });

            // 9. Directory Data
            aggregatedData.directory = processCollection(directoryCsv, 'directory', (item) => {
                item.Salary = parseFloat(item.Salary) || 0;
                item['Joind On'] = parseDateString(item['Joind On']);
                return item;
            });
            
            log('Data aggregation complete. Ready to generate JSON file.');
            return aggregatedData;
        }

        /**
         * Downloads the given JSON object as a file.
         */
        function downloadJsonFile(data, filename) {
            const jsonString = JSON.stringify(data, null, 2);
            const blob = new Blob([jsonString], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            log(`JSON file '${filename}' downloaded successfully.`);
        }


        // --- Main Controller ---
        function processAndExportData() {
            processButton.disabled = true;
            statusEl.textContent = 'Processing and converting data...';
            logEl.innerHTML = '<h2 class="font-bold text-gray-800 sticky top-0 bg-[#f0fdf4] pb-2 border-b border-gray-200">Processing Log:</h2>';

            try {
                const finalData = aggregateData();
                const timestamp = new Date().toISOString().slice(0, 19).replace(/[-:]/g, '').replace('T', '_');
                const filename = `enviro_helpdesk_data_${timestamp}.json`;
                
                downloadJsonFile(finalData, filename);

                statusEl.textContent = `Success! Data exported as '${filename}'.`;
            } catch (e) {
                statusEl.textContent = 'An error occurred during processing.';
                log(`FATAL ERROR: ${e.message}`, true);
                console.error('Processing Error:', e);
            } finally {
                processButton.disabled = false;
            }
        }

        processButton.addEventListener('click', processAndExportData);
    </script>
</body>
</html>
